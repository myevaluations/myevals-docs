{"module":"APE","displayName":"Annual Program Evaluation","procedureCount":13,"procedures":[{"name":"GetAPEOverallDashboardResultsByDept","schema":"dbo","parameters":[{"name":"@DepartmentID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@AcadamicYear","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@APEGroupID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@SectionID","dataType":"LargeNumber","direction":"IN","defaultValue":null}],"lineCount":205,"tablesReferenced":["APE_CorePersonnel","APE_CorePersonnelUsers","APE_OverallDashboard","APE_SubSections","DH_CCConferenceScheduleTemplate","DH_CCConferenceTemplate","DH_CCEvaluation","DH_ConferenceSchedules","EVAL_Evaluations","EVAL_Templates","PF_DocumentCreditSubject","PF_UserDocuments","SEC_Departments","SEC_UserTypes","SEC_Users"],"sprocsCalledFromBody":["GetDutyHourAPEOverallDashBoardDetails"],"crudType":"get","antiPatterns":{"hasCursor":false,"hasSelectStar":true,"hasDynamicSql":false,"hasNolock":true,"nolockCount":3,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"very-complex","aiEnrichment":null,"module":"APE","summary":"Generates a comprehensive department-level APE dashboard by computing evaluation completion rates across configurable time bands (0-15, 16-30, 31-60, 61-90, >90 days before deadline), delegating duty-hour calculations to GetDutyHourAPEOverallDashBoardDetails, and aggregating scholarly activity counts (publications, grants, abstracts, leadership roles) for a given department, academic year, APE group, and sub-section. Results are cached in APE_OverallDashboard and refreshed only when the cached record is older than 3 hours.","businessPurpose":"Powers the APE department dashboard view used by program directors to monitor resident/faculty evaluation completion health and scholarly productivity for a given academic year. This is a central reporting entry point for the Annual Program Evaluation workflow in residency programs.","optimizationRecommendations":["Replace the DELETE + INSERT cache-refresh pattern for APE_OverallDashboard with an UPSERT (MERGE) to reduce lock contention on the cache table.","The dbo.fnsplit(@APEUsertypes, ',') scalar string-split function is called multiple times inside large CTEs and WHERE clauses; replace with a single inline table-valued split (STRING_SPLIT in SQL Server 2016+) and join once to a temp table to avoid repeated parsing.","The scholarly activity query builds a #TempSCADeptReportInfo temp table but then runs a GROUP BY aggregation against it outside the cache-refresh IF block, meaning scholarly data is always recalculated even when the dashboard cache is still fresh — move it inside the @RefreshData = 'True' block or add a separate cache column.","The large CTE TBL unions EVAL_Evaluations and DH_CCEvaluation with several INNER JOINs; consider a filtered index on EVAL_Evaluations(TargetUserID, IsDeleted, IsTemplateDepartmentClosed) including StartDate/ExpirationDate columns to support the date-range filter.","The 3-hour cache granularity is hard-coded; make it a configurable parameter or application setting to allow tuning without a schema change."],"migrationRelevance":"high"},{"name":"GetAPERRCAreasByAcademicYear","schema":"dbo","parameters":[{"name":"@UserID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@AcademicYear","dataType":"LargeNumber","direction":"IN","defaultValue":null}],"lineCount":26,"tablesReferenced":["APE_RRCArea","SEC_Departments"],"sprocsCalledFromBody":[],"crudType":"get","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"simple","aiEnrichment":null,"module":"APE","summary":"Returns all active RRC (Residency Review Committee) area definitions for a given department, ordered alphabetically by area description. The academic year parameter is accepted but currently commented out from the filter.","businessPurpose":"Populates RRC area dropdown selectors used when program directors fill out APE sub-sections that map performance concerns or improvements to accreditation-relevant RRC focus areas.","optimizationRecommendations":["The @AcademicYear parameter is declared but unused (commented out); either add it back to the WHERE clause or remove it from the signature to avoid misleading callers.","Add a covering index on APE_RRCArea(DepartmentID, IsDeleted) INCLUDE (RRCAreaID, AreaDesc) to eliminate the table scan on what is likely a small lookup table."],"migrationRelevance":"low"},{"name":"GetDutyHourAPEOverallDashBoardDetails","schema":"dbo","parameters":[{"name":"@DepartmentID","dataType":"LargeNUmber","direction":"IN","defaultValue":null},{"name":"@AcademicYear","dataType":"SmallNumber","direction":"IN","defaultValue":null},{"name":"@APEGroupID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@SectionID","dataType":"LargeNumber","direction":"IN","defaultValue":null}],"lineCount":186,"tablesReferenced":["APE_CorePersonnel","APE_CorePersonnelUsers","APE_OverallDashboard","APE_SubSections","SEC_Users"],"sprocsCalledFromBody":["GetSummaryComplainceReportResult"],"crudType":"get","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":true,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"complex","aiEnrichment":null,"module":"APE","summary":"Computes duty-hour compliance metrics for APE core personnel within an academic year — including shift confirmation rates and ACGME violation counts (80-hour rule, 1-in-7 days, 24-hour limit, 10-hour rest, call frequency, night-float) — and writes the results into the APE_OverallDashboard cache table. It delegates to GenerateDepartmentCompletionStatusReport and GetSummaryComplainceReportResult for the underlying schedule data.","businessPurpose":"Provides the duty-hours compliance subsection of the APE department dashboard, giving program directors a consolidated view of ACGME duty-hour rule violations across rotations for the selected academic year. Called internally by GetAPEOverallDashboardResultsByDept when SubSectionID = 2.","optimizationRecommendations":["The procedure uses a cursor-style WHILE loop over @UserList to call GetSummaryComplainceReportResult one user at a time, which is an RBAR (row-by-agonizing-row) pattern; refactor the called SP to accept a user list or use a set-based approach with FOR XML or STRING_AGG to batch the calls.","The FOR XML PATH string concatenation to build @UserIDList is legacy and error-prone with large user counts; replace with STRING_AGG (SQL Server 2017+) or a TVF.","Multiple DECLARE TABLE variables (@Schedule, @ViolationCountDetails, @CompletionDetails) hold large intermediate result sets that could benefit from being #temp tables with explicit indexes for better statistics and spill-to-disk support.","Duplicate temp population: #TempAPECorePersonnel is built with a similar pattern here and in the parent SP (GetAPEOverallDashboardResultsByDept); consider passing core personnel as a TVP to reduce redundant joins."],"migrationRelevance":"high"},{"name":"GetIncompleteTakeActions","schema":"dbo","parameters":[],"lineCount":28,"tablesReferenced":["APE_SubSectionTabs","APE_SubSections","APE_TakeAction","APE_TakeActionStatus"],"sprocsCalledFromBody":[],"crudType":"get","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":true,"hasTableVariable":false,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"moderate","aiEnrichment":null,"module":"APE","summary":"Retrieves all APE take-action records for a given calendar year that have not yet reached 'Implemented Fully' status, returning full action detail including area of concern, plans, assignee, and due date.","businessPurpose":"Drives the incomplete take-actions list view in the APE module, allowing program administrators to track outstanding improvement actions from previous annual evaluations and follow up with assigned personnel.","optimizationRecommendations":["The filter Datepart(Year, ta.CreatedDate) = @CurrentYear is non-sargable and prevents index use on CreatedDate; rewrite as ta.CreatedDate >= '${year}-01-01' AND ta.CreatedDate < '${year+1}-01-01' using parameterized date boundaries.","Add a covering index on APE_TakeAction(TakeActionStatusID, CreatedDate) INCLUDE (TakeActionID, AreaofConcern, ActionPlan, DueDate, AdminAssignedTo, SubSectionTabID) to avoid a table scan."],"migrationRelevance":"medium"},{"name":"GetParticipationTypes","schema":"dbo","parameters":[{"name":"@UserID","dataType":"LargeNumber","direction":"IN","defaultValue":null}],"lineCount":28,"tablesReferenced":["APE_ParticipationTypes","PRC_ParticipationTypes"],"sprocsCalledFromBody":[],"crudType":"get","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"simple","aiEnrichment":null,"module":"APE","summary":"Returns a deduplicated list of participation types applicable to a department by UNIONing global (system-wide, DepartmentID IS NULL) and department-specific types from PRC_ParticipationTypes, using ROW_NUMBER to prefer department-specific records when names collide.","businessPurpose":"Populates participation type selectors used across APE conference and meeting tracking sub-sections, allowing programs to use both standard platform-wide types and program-specific custom types.","optimizationRecommendations":["The double-nested subquery with ROW_NUMBER wrapping a UNION can be replaced with a single query using COALESCE or a LEFT JOIN to department-specific overrides, which is more readable and potentially more efficient.","The LEFT JOIN to APE_ParticipationTypes (PC) in the second UNION branch is used only for the IsDeleted filter but is not semantically documented; clarify or replace with a direct WHERE clause on PRC_ParticipationTypes."],"migrationRelevance":"low"},{"name":"GetPendingTakeActionReminder","schema":"dbo","parameters":[],"lineCount":33,"tablesReferenced":["APE_TakeAction","APE_TakeActionStatus"],"sprocsCalledFromBody":[],"crudType":"get","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":true,"hasTableVariable":false,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"simple","aiEnrichment":null,"module":"APE","summary":"Retrieves take-action records whose DueDate exactly equals a date three months in the past and whose status is not 'Implemented Fully', used to identify overdue action plans that need reminder notifications.","businessPurpose":"Supports automated reminder dispatch in the APE module, flagging action plans that were due 3 months ago but remain incomplete, enabling the system or an administrator to send follow-up alerts to assigned personnel.","optimizationRecommendations":["The DueDate filter uses DueDate = DATEADD(MONTH, -3, GETDATE()), which relies on an exact date-time match; because DueDate may be stored as a date-only value while GETDATE() includes time, this comparison will almost never match in practice — use CAST(DueDate AS DATE) = CAST(DATEADD(MONTH, -3, GETDATE()) AS DATE) or a date range.","Add an index on APE_TakeAction(DueDate, TakeActionStatusID) to support the filtered lookup rather than a full table scan."],"migrationRelevance":"medium"},{"name":"GetProgramDutyHoursComplaince_V2","schema":"dbo","parameters":[{"name":"@UserId","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@DepartmentID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@AcademicYear","dataType":"SmallNumber","direction":"IN","defaultValue":null}],"lineCount":116,"tablesReferenced":["APE_CorePersonnel","APE_CorePersonnelUsers"],"sprocsCalledFromBody":["GetSummaryComplainceReportResult"],"crudType":"get","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"moderate","aiEnrichment":null,"module":"APE","summary":"Calculates program-wide duty-hour compliance for APE core personnel across an academic year by building a user list, fetching schedule data via GetUserIDsByCriteria and GenerateDepartmentCompletionStatusReport, then aggregating ACGME violation counts by rotation and returning compliance summaries along with linked department IDs.","businessPurpose":"Provides the consolidated duty-hour compliance view for an entire residency program (as opposed to per-department), displayed on the APE program dashboard to show whether the program meets ACGME duty-hour regulations across all rotations for the academic year.","optimizationRecommendations":["The procedure uses legacy FOR XML PATH string concatenation to build @UserIDList; replace with STRING_AGG (SQL Server 2017+) for clarity and performance.","The @DutyHours table variable stores many columns and acts as a large intermediate result set; switching to a #temp table would allow SQL Server to generate better statistics and execution plans.","EXEC calls to external SPs inside loops or as part of complex data assembly sequences make query plan caching impossible for the outer SP; consider refactoring into inline views or TVFs where feasible.","Multiple explicit CAST conversions on date functions (CONVERT to VARCHAR then back) for @StartDate/@EndDate should be replaced with strongly-typed date parameters to avoid implicit conversions in execution plans."],"migrationRelevance":"high"},{"name":"GetSummaryActionPlanActivities","schema":"dbo","parameters":[],"lineCount":59,"tablesReferenced":["APE_TakeAction","APE_TakeActionStatus"],"sprocsCalledFromBody":[],"crudType":"get","antiPatterns":{"hasCursor":false,"hasSelectStar":true,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":true,"hasTableVariable":true,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"moderate","aiEnrichment":null,"module":"APE","summary":"Returns a year-over-year comparison table of take-action plan counts (total, completed, and incomplete) for the current and previous calendar years using a series of UPDATE statements against an in-memory table variable.","businessPurpose":"Powers the APE summary dashboard widget that shows program directors whether the volume of improvement action plans and their completion rate has changed compared to the prior year, supporting accreditation self-assessment.","optimizationRecommendations":["The six scalar subquery UPDATEs against a table variable each trigger separate COUNT scans of APE_TakeAction; consolidate into a single aggregation CTE with conditional SUM to perform just one pass over the table.","The Datepart(Year, CreatedDate) non-sargable filter pattern is repeated six times; parameterize as date-range boundaries once and reuse.","The table variable @SummaryActionPlan has no index; for the pivot-style UPDATE pattern a #temp table with a clustered index on Plans would be slightly more efficient for repeated lookups."],"migrationRelevance":"medium"},{"name":"InSertAPETracker","schema":"dbo","parameters":[{"name":"@APEID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@Section","dataType":"ShortText","direction":"IN","defaultValue":null},{"name":"@SubSection","dataType":"ShortText","direction":"IN","defaultValue":null},{"name":"@SubSectionTabCode","dataType":"ShortText","direction":"IN","defaultValue":null},{"name":"@ModifiedBy","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@ModifiedDate","dataType":"LargeDate","direction":"IN","defaultValue":null}],"lineCount":22,"tablesReferenced":["APE_Sections","APE_SubSectionTabs","APE_SubSections","APE_Tracker"],"sprocsCalledFromBody":[],"crudType":"insert","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":true,"hasTableVariable":false,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"moderate","aiEnrichment":null,"module":"APE","summary":"Resolves section, sub-section, and sub-section-tab IDs from their name/code parameters and inserts a tracker record into APE_Tracker capturing the previous and revised content of an APE field along with submitter and timestamp metadata.","businessPurpose":"Provides audit-trail logging for the APE module, recording every content change made to APE data fields (e.g., narrative sections, scholarly activity notes) so that program directors can review revision history for accreditation documentation.","optimizationRecommendations":["The three sequential SELECT lookups to resolve @SectionID, @SubSectionID, and @SubSectionTabID could be combined into a single JOIN query to reduce round-trips and simplify the logic.","Consider passing @SectionID, @SubSectionID, and @SubSectionTabID as direct integer parameters from the application layer — the name-based lookups add fragility if names ever change."],"migrationRelevance":"low"},{"name":"UpdateMyPQualityImprovementProjects_test5","schema":"dbo","parameters":[{"name":"@DepartmentID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@UserID","dataType":"LargeNumber","direction":"IN","defaultValue":null}],"lineCount":187,"tablesReferenced":["APE_Projects","APE_ProjectsLeaders","APE_ProjectsParticipants","APE_QIProjectLeaders","APE_QIProjectParticipants","APE_QIProjects","APE_SubSectionTabs"],"sprocsCalledFromBody":[],"crudType":"update","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":true,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"complex","aiEnrichment":null,"module":"APE","summary":"Upserts quality improvement (QI) projects for an APE record — inserting new APE_QIProjects and APE_Projects rows, updating existing ones, and synchronizing project leaders and participants through APE_ProjectsLeaders and APE_ProjectsParticipants — while handling Duty Hours category flag extraction from ProgramCategoryID encoding.","businessPurpose":"Persists quality improvement project entries submitted through the APE My Portfolio QIP interface, covering both program-level QI projects and resident/faculty QI activities tracked as part of annual program self-study under ACGME requirements.","optimizationRecommendations":["The procedure name ends with '_test5', indicating it is a test/development version that was promoted to production; it should be renamed to a stable production name and the old test versions cleaned up.","The ProgramCategoryID encoding using '@1'/'@0' as flags for IsDutyHoursCategory is a fragile string hack; this should be refactored into a dedicated boolean parameter or column.","Multiple INSERT/UPDATE/DELETE operations without explicit transaction management risk partial commits if an intermediate statement fails; wrap in an explicit BEGIN TRANSACTION / COMMIT / ROLLBACK with TRY/CATCH.","The pattern of passing a table-valued parameter (@tblAPEProjects) and then copying it into @tblTempAPEProjects (another table variable) doubles memory usage; process the TVP directly after the flag extraction UPDATE.","SCOPE_IDENTITY() is captured but the variable @ID is never used after assignment — this dead code should be removed."],"migrationRelevance":"high"},{"name":"UpdateScholarlyActivities","schema":"dbo","parameters":[{"name":"@APEID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@CompletionID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@SubSection","dataType":"ShortText","direction":"IN","defaultValue":null},{"name":"@SubSectionTabCode","dataType":"ShortText","direction":"IN","defaultValue":null},{"name":"@CreatedBy","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@ModifiedBy","dataType":"LargeNumber","direction":"IN","defaultValue":null}],"lineCount":44,"tablesReferenced":["APE_Completion","APE_CompletionData","APE_SubSectionTabs","APE_SubSections"],"sprocsCalledFromBody":[],"crudType":"update","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":true,"hasTableVariable":false,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"moderate","aiEnrichment":null,"module":"APE","summary":"Upserts an APE completion record (APE_Completion) and its associated training-level data rows (APE_CompletionData) for a given APE sub-section, supporting both insert-on-first-submission and update-on-revision patterns via a passed CompletionID sentinel value.","businessPurpose":"Persists the scholarly activities completion status for APE sub-sections, recording how many scholarly activities (auto-tracked and manually entered) each training level has submitted versus what is required for the academic year's annual program evaluation.","optimizationRecommendations":["The @@ROWCOUNT check after the UPDATE on APE_CompletionData to decide whether to INSERT is a common pattern but relies on implicit transaction isolation; make the upsert explicit with MERGE or an EXISTS check for clarity.","The name-based lookup for @SubSectionID and @SubSectionTabID (same fragility as InSertAPETracker) should use ID-based parameters passed from the application layer.","Add a unique constraint on APE_CompletionData(CompletionID, TrainingLevelID) to ensure the UPDATE/INSERT logic cannot create duplicate rows under concurrent access."],"migrationRelevance":"medium"},{"name":"usp_PerformanceQIP_API","schema":"dbo","parameters":[{"name":"@UserID","dataType":"LargeNumber","direction":"IN","defaultValue":null}],"lineCount":461,"tablesReferenced":["APE_FacultyTopicCategories","APE_Main","APE_ProgramStatus","APE_Projects","APE_ProjectsLeaders","APE_ProjectsParticipants","APE_QIProjects","APE_SubSectionTabs","APE_SubSections","APE_TakeAction","DH_CCTopicCategories","MYEval_PerformanceQIProjectsDetails","PF_QIProjectDocument","SEC_Departments"],"sprocsCalledFromBody":[],"crudType":"mixed","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"complex","aiEnrichment":null,"module":"APE","summary":"Provides a paginated, filterable API endpoint for listing QI projects across APE sub-sections (residents, faculty, program), applying dynamic search filters (keyword, file type, date range, last-updated window) via dynamically constructed NVARCHAR(MAX) SQL strings and returning results with total counts for pagination.","businessPurpose":"Powers the QI project search and list views in the APE My Portfolio interface, enabling program directors and residents to browse, filter, and paginate through all quality improvement projects linked to a program's annual evaluation — supporting ACGME documentation requirements.","optimizationRecommendations":["The SP builds and executes dynamic SQL via NVARCHAR(MAX) string concatenation using EXEC, which is vulnerable to SQL injection (user-controlled @SEARCHWORD is directly interpolated); rewrite using sp_executesql with parameterized inputs.","The dynamic SQL approach makes query plan caching effectively impossible for different filter combinations; consider materializing common filter results into a #temp table first and then applying secondary filters in static SQL.","The LastUpdatedValue date-range logic contains a bug: when @LastUpdatedValue = 0 (any time), it sets @LastUpdatedValueSQLQuery to '' but then uses it in a string that produces 'OR DateSubmitted >= ''' which is syntactically invalid; this branch needs a proper conditional to emit an empty string.","The procedure declares ~25 local variables at the top but many (e.g., @CloseBracesFlag, @CloseBracesFlag2) appear to be vestigial from earlier search logic iterations; audit and remove unused variables.","The FOR XML PATH ApeIDs concatenation and linked-department lookup with RetrieveDepartments should be replaced with a set-based join using STRING_SPLIT or a proper TVF to avoid string-based ID passing."],"migrationRelevance":"high"},{"name":"usp_SaveSurveyInsights","schema":"dbo","parameters":[{"name":"@DepartmentID","dataType":"BIGINT","direction":"IN","defaultValue":null},{"name":"@UserID","dataType":"BIGINT","direction":"IN","defaultValue":null},{"name":"@AcademicYear","dataType":"INT","direction":"IN","defaultValue":null},{"name":"@IsResident","dataType":"TINYINT","direction":"IN","defaultValue":null},{"name":"@SurveyID","dataType":"BIGINT","direction":"IN","defaultValue":"0"},{"name":"@SurveyAssessmentType","dataType":"NVARCHAR(50)","direction":"IN","defaultValue":"'annual-program-evaluation'"},{"name":"@Stage1Prompt","dataType":"NVARCHAR(MAX)","direction":"IN","defaultValue":null},{"name":"@Stage2Prompt","dataType":"NVARCHAR(MAX)","direction":"IN","defaultValue":null},{"name":"@JsonPITs","dataType":"NVARCHAR(MAX)","direction":"IN","defaultValue":null},{"name":"@JsonActionPlans","dataType":"NVARCHAR(MAX)","direction":"IN","defaultValue":null}],"lineCount":410,"tablesReferenced":["APE2_Survey","APE2_SurveyGeneratedInsights","APE2_SurveyToGenerateInsightsFor","APE_InsightCPRReferences","APE_SurveyGeneratedHistory","APE_SurveyInsightHistory","APE_SurveyInsightPITActionPlans","APE_SurveyInsightPITCPRReferences","APE_SurveyInsightPITs","APE_SurveyInsights","APE_SurveyToGenerateInsightsHistory"],"sprocsCalledFromBody":[],"crudType":"mixed","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":false},"calledFromCode":[],"complexity":"complex","aiEnrichment":null,"module":"APE","summary":"Within an explicit transaction, persists AI-generated survey insights for resident or faculty annual/well-being surveys by upserting APE_SurveyInsights and APE_SurveyInsightHistory records, appending an immutable audit row to APE_SurveyGeneratedHistory, then performing a full replace of associated Problems-in-Training (PITs) and Action Plans through staging temp tables (#SrcPITs, #NewPITs, #SrcAPs, #NewAPs) parsed from JSON parameters.","businessPurpose":"Saves Claude/AI-generated insights and structured action plans derived from resident and faculty APE survey data back into the platform, enabling program directors to review, edit, and finalize AI-assisted annual program evaluation narratives and improvement plans.","optimizationRecommendations":["The JSON PIT and Action Plan inputs are parsed via staging temp tables with IDENTITY rows for rownum-based matching; ensure the JSON parsing (presumably using OPENJSON or a custom parser) is indexed on RowNum to avoid nested-loop inefficiency during the INSERT-then-UPDATE pattern.","The explicit OBJECT_ID('tempdb..#table') DROP-before-CREATE pattern is correct but verbose; use CREATE TABLE IF NOT EXISTS syntax (SQL Server 2016+) or structured session temp table management.","APE_SurveyGeneratedHistory is always appended (never updated), creating an unbounded audit log; ensure this table has a retention/archival strategy and a clustered index on (DepartmentID, AcademicYear, CreatedDate).","The SurveyType CASE expression for @IsResident (values 0,1,2,3) is duplicated in both the INSERT to APE_SurveyInsights and inline; extract to a single SET statement before the INSERT."],"migrationRelevance":"high"}]}