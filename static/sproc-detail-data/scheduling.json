{"module":"SCHE","displayName":"Scheduling","procedureCount":18,"procedures":[{"name":"CompleteArchivingProcess","schema":"dbo","parameters":[{"name":"@ArchivedDate","dataType":"LargeDate","direction":"IN","defaultValue":null},{"name":"@InitatedUserID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@UserID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@IsArchiveWhilePromoting","dataType":"VerySmallNumber","direction":"IN","defaultValue":null}],"lineCount":167,"tablesReferenced":["EVAL_Evaluations","SCHE_ArchivePromotionEventLog","SCHE_ArchiveQueueUsers","SCHE_ArchiveScheduleQueue","SCHE_PromotionQueueUsers","SCHE_PromotionScheduleQueue","SEC_UserRoles","SEC_Users"],"sprocsCalledFromBody":["spLOG_ErrorHandling"],"crudType":"mixed","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":true,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":false},"calledFromCode":[],"complexity":"complex","aiEnrichment":null,"module":"SCHE","summary":"Executes the core archiving logic for a single user: marks them archived in SEC_USERS, updates their role to a non-active role (RoleID=8), handles department assignment for Group Administrator users, soft-deletes or closes any open evaluation assignments where the archived user is the evaluator or subject, and logs the event in SCHE_ArchivePromotionEventLog.","businessPurpose":"Central workhorse of the user archiving pipeline in MyEvaluations. When a resident or faculty member completes a rotation block and is transitioned out of a department, this SP applies all downstream side-effects: role demotion, ownership reassignment of administrative items to the default admin, closure of pending evaluations, and inbox archiving. It is called per-user by a scheduled job or batch process driven by the archive queue.","optimizationRecommendations":["The SP uses READ UNCOMMITTED isolation globally but performs multiple correlated UPDATE statements — consider scoping the isolation level only to the read-heavy initial queries to avoid stale data on writes.","The repeated EXISTS checks against SCHE_ArchiveScheduleQueue and SCHE_PromotionScheduleQueue (at least 4 separate lookups with identical predicates) should be collapsed into a single lookup that populates local variables once at the top of the procedure.","The UPDATE to EVAL_Evaluations for IsDeleted and the subsequent UPDATE for ClosedDate both scan the same base table filtered through table-variable joins — combining these into a single MERGE or conditional UPDATE would reduce I/O.","Table variables @TempEvals and @TempPendingEvals lack indexes; adding a primary key or clustered index on EvaluationID would improve join performance when those sets are large.","The SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED is set globally but the procedure does not wrap the writes in an explicit transaction — dirty writes are possible if a later statement fails, and a TRY/CATCH with ROLLBACK should guard the entire mutation block."],"migrationRelevance":"high"},{"name":"CopydataFromQueTableToTempTable","schema":"dbo","parameters":[],"lineCount":49,"tablesReferenced":["SCHE_ApplicationEmailSchedules","SCHE_ApplicationEmailSchedulesTemp"],"sprocsCalledFromBody":["spLOG_ErrorHandling"],"crudType":"mixed","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":true,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":false},"calledFromCode":[],"complexity":"simple","aiEnrichment":null,"module":"SCHE","summary":"Moves up to 10,000 sent email records older than one month from SCHE_ApplicationEmailSchedules into the archive table SCHE_ApplicationEmailSchedulesTemp, then deletes the moved rows from the source table.","businessPurpose":"Maintenance job that keeps the active application email queue table lean by migrating aged, successfully-sent emails to a temp/archive table. This prevents the scheduler email queue from growing unboundedly over time and maintains query performance for the email sending pipeline.","optimizationRecommendations":["The TOP 10000 batch size is hardcoded and may need tuning; parameterising or increasing the batch size would reduce job run frequency.","The date calculation for @PreviousMonthDate uses string concatenation and multiple CONVERT calls; DATEADD(MONTH, -1, CAST(GETDATE() AS DATE)) is simpler, more readable, and avoids potential off-by-one errors.","The NOT EXISTS anti-join on SCHE_ApplicationEmailSchedulesTemp is evaluated per-row — an index on ApplicationEmailScheduleID in the temp table would speed this dramatically if the table is large.","The OUTPUT clause feeds a table variable that is then used for the DELETE — this is correct, but if the batch is very large the table variable will be unindexed; consider using a temp table with an index instead."],"migrationRelevance":"medium"},{"name":"DeleteApplicationOlderMails","schema":"dbo","parameters":[],"lineCount":25,"tablesReferenced":["SCHE_ApplicationEmailSchedules"],"sprocsCalledFromBody":[],"crudType":"delete","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"simple","aiEnrichment":null,"module":"SCHE","summary":"Deletes up to 50,000 sent emails from SCHE_ApplicationEmailSchedules where IsMailSent=1 and the record is older than 365 days.","businessPurpose":"Routine housekeeping job that purges stale, successfully-sent emails from the application email scheduler table. Prevents the table from growing excessively large and degrading email queue query performance.","optimizationRecommendations":["The WHERE clause uses DATEDIFF(dd, CreatedDateTime, GETDATE()) > 365 AND DATEDIFF(dd, CreatedDateTime, GETDATE()) NOT BETWEEN 0 AND 365 — the NOT BETWEEN condition is redundant since >365 already excludes 0-365; removing it simplifies the predicate.","DATEDIFF on a column is non-sargable and prevents index use on CreatedDateTime; replace with a direct comparison: CreatedDateTime < DATEADD(DAY, -365, GETDATE()).","The additional AND DATEDIFF(...) > 0 guard against negative values is also redundant given the >365 predicate; remove to reduce function evaluation overhead.","Consider running this in a loop with smaller batches (e.g., 5,000 rows) to avoid long lock durations on a high-traffic table."],"migrationRelevance":"low"},{"name":"DeleteUserJob","schema":"dbo","parameters":[],"lineCount":156,"tablesReferenced":["DeletedUserDetails","SCHE_ApplicationEmailSchedules"],"sprocsCalledFromBody":["DeleteUser"],"crudType":"delete","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"complex","aiEnrichment":null,"module":"SCHE","summary":"Processes up to 10 soft-deleted users (IsDeleted=0 pending physical deletion, excluding department 1433) by calling dbo.DeleteUser per user in a WHILE loop with a 200ms delay between iterations, then generates an HTML summary email to the internal team.","businessPurpose":"Off-business-hours batch job that physically removes user records that have been flagged for deletion from the system, while excluding the special Medcom department (1433) which has its own dedicated SP. After deletion, it sends an HTML report email to the internal MyEvaluations operations team summarising which users were deleted and whether each deletion succeeded.","optimizationRecommendations":["The WHILE loop with a WAITFOR DELAY '00:00:00.200' between iterations serialises what could be set-based operations; the 200ms delay is likely intended to throttle load but means the job takes at least 2 seconds for 10 users regardless of actual DB load.","HTML is built via string concatenation inside a WHILE loop (cursor-equivalent pattern) — this should be replaced with FOR XML PATH or STRING_AGG for the HTML table rows.","The hardcoded exclusion of department 1433 and a long IN list of hardcoded UserIDs is a maintenance liability; these should be driven by a configuration table.","TOP 10 batch size means many job runs may be needed for large backlogs; consider increasing the batch size or adding a configurable parameter.","The email is sent to hardcoded addresses ('myevals@jivainfotech.com'); these should be configuration-driven."],"migrationRelevance":"medium"},{"name":"DeleteUserJobForMedcomDepartment","schema":"dbo","parameters":[],"lineCount":143,"tablesReferenced":["DeletedUserDetails","SCHE_ApplicationEmailSchedules"],"sprocsCalledFromBody":["DeleteUser"],"crudType":"delete","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"moderate","aiEnrichment":null,"module":"SCHE","summary":"Identical in structure to DeleteUserJob but specifically targets users from department 1433 (Medcom), processing up to 20 users per run and excluding a hardcoded list of protected UserIDs, then sends an HTML report email.","businessPurpose":"Department-specific variant of the user deletion batch job for the Medcom department (LoggedInDepartmentID=1433), which has a separate job due to its special handling requirements and a large exclusion list of protected user accounts. Provides the same HTML summary email to the internal team after each run.","optimizationRecommendations":["The hardcoded exclusion list of 38 specific UserIDs is a significant maintenance liability — these should be stored in a dedicated configuration or exception table and joined rather than listed inline.","The procedure duplicates almost all logic from DeleteUserJob; these should be merged into a single parameterised procedure with a @DepartmentID parameter to eliminate code duplication.","Same WHILE loop cursor-equivalent pattern for HTML generation — replace with FOR XML PATH or STRING_AGG.","ORDER BY U.CreatedDate DESC on the top 20 selection means the newest records are deleted first; confirm this is the intended order, as it may differ from DeleteUserJob's implicit ordering."],"migrationRelevance":"medium"},{"name":"GenerateArchivedUserEmail","schema":"dbo","parameters":[{"name":"@ImageType","dataType":"LargeText","direction":"IN","defaultValue":null},{"name":"@UserID","dataType":"BigNumber","direction":"IN","defaultValue":null}],"lineCount":89,"tablesReferenced":["SCHE_ApplicationEmailSchedules","SCHE_ArchivedUserMailQueue","SEC_Departments"],"sprocsCalledFromBody":["GetArchivedUserEmailInformation"],"crudType":"delete","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":false},"calledFromCode":[],"complexity":"moderate","aiEnrichment":null,"module":"SCHE","summary":"Generates and queues a notification email for a newly archived user by calling GetArchivedUserEmailInformation to build the email content, inserting it into SCHE_ApplicationEmailSchedules, and marking the ArchivedUserMailQueue record as email-generated, while skipping users from closed or disabled departments.","businessPurpose":"Sends the archived user their new login credentials and account status notification email as part of the archiving workflow. The email is routed through the application email scheduler (method 5) and respects department closure status to avoid sending emails to users associated with closed programs.","optimizationRecommendations":["The department closure check uses a LIKE '%CLOSED%' pattern match on the department name — this is fragile and non-sargable; a dedicated IsDisabled flag or a formal status column should be the sole closure indicator.","The INSERT ... EXEC pattern (inserting result of GetArchivedUserEmailInformation into SCHE_ApplicationEmailSchedules) followed by a separate UPDATE on SCOPE_IDENTITY() requires two round-trips; refactoring the called SP to accept output parameters or return a single result set would reduce this.","The transaction uses BEGIN TRANSACTION / COMMIT TRANSACTION inside a nested TRY/CATCH but the outer procedure has no transaction boundary — if the outer scope fails after this commits, partial state is possible."],"migrationRelevance":"high"},{"name":"GeneratePromotedUserEmail","schema":"dbo","parameters":[{"name":"@ImageType","dataType":"LargeText","direction":"IN","defaultValue":null},{"name":"@OldUserID","dataType":"BigNumber","direction":"IN","defaultValue":null},{"name":"@QueueId","dataType":"BigNumber","direction":"IN","defaultValue":null},{"name":"@IsPromoteFE","dataType":"INT","direction":"IN","defaultValue":"0"},{"name":"@IsPromotingOnly","dataType":"TINYINT","direction":"IN","defaultValue":"0"}],"lineCount":100,"tablesReferenced":["SCHE_ApplicationEmailSchedules","SCHE_PromotedUserMailQueue","SCHE_PromotionQueueUsers","SEC_Users"],"sprocsCalledFromBody":["GetPromotedUserEmailInformation","GetUserEmailInformation"],"crudType":"mixed","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"moderate","aiEnrichment":null,"module":"SCHE","summary":"Generates and queues a welcome/credentials email for a promoted user, with branching logic to select different email templates based on whether the promotion is a full promotion-only, a promotion with archiving, or a standard user email, then marks the PromotedUserMailQueue record as email-generated.","businessPurpose":"Sends the promoted user their new credentials and welcome email when they are moved to a new department or role in the MyEvaluations system. Supports multiple promotion scenarios (promote-only, promote-and-archive) through conditional template selection, ensuring the correct email content is sent for each transition type.","optimizationRecommendations":["The nested IF/ELSE branching on @IsPromoteFE, @IsPromotingOnly, and @IsArchive creates three different INSERT ... EXEC paths that are nearly identical — this logic should be extracted into a helper that selects the appropriate SP name based on parameters.","The UPDATE to SCHE_PromotedUserMailQueue uses 'WHERE OldUserID =@OldUserID and PromotionQueueID=PromotionQueueID' — the second predicate 'PromotionQueueID=PromotionQueueID' is comparing the column to itself (a no-op tautology) and should be 'PromotionQueueID=@QueueId'.","BEGIN TRAN / COMMIT TRAN is used but no ROLLBACK is present in a CATCH block — a failed INSERT would leave the transaction open; explicit error handling with ROLLBACK TRANSACTION is needed.","The COMMIT TRAN followed by 'IF @@trancount > 0 ROLLBACK TRAN' pattern is logically contradictory — after COMMIT the trancount drops to 0, so the ROLLBACK branch is unreachable."],"migrationRelevance":"high"},{"name":"GetApplicationEmailSend_TEST","schema":"dbo","parameters":[],"lineCount":50,"tablesReferenced":["SCHE_ApplicationEmailSchedules","SEC_Users"],"sprocsCalledFromBody":[],"crudType":"get","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"moderate","aiEnrichment":null,"module":"SCHE","summary":"A test/diagnostic query that retrieves the top 1,000 unsent emails from SCHE_ApplicationEmailSchedules for a specific department and send method, overriding the ToEmailAddress with a hardcoded internal test address.","businessPurpose":"Development and QA utility used to inspect pending outbound emails without triggering actual sends to real recipients. The hardcoded test email override ('myevals@jivainfotech.com') and department/method filters indicate this was used to verify specific email campaigns or troubleshoot the email scheduler for a particular department.","optimizationRecommendations":["This SP contains hardcoded department ID (2207), method number (37), and a test email address — it should not exist in production as a stored procedure and should be replaced with a parameterised diagnostic view or ad-hoc query.","Multiple commented-out WHERE clauses suggest this SP has been modified repeatedly for one-off testing and is not maintained — it should be removed from production to avoid confusion.","The NOLOCK hint on SCHE_ApplicationEmailSchedules is appropriate for a read-only diagnostic query, but the INNER JOIN to SEC_Users also uses NOLOCK, which could return orphaned email records if users are being concurrently deleted."],"migrationRelevance":"none"},{"name":"GetCSVColumList","schema":"dbo","parameters":[{"name":"@MappingId","dataType":"BigNumber","direction":"IN","defaultValue":null}],"lineCount":30,"tablesReferenced":["SCHE_TranformationTableColumns"],"sprocsCalledFromBody":["spLOG_ErrorHandling"],"crudType":"get","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":false},"calledFromCode":[],"complexity":"simple","aiEnrichment":null,"module":"SCHE","summary":"Returns the comma-separated source and target column name lists for a given transformation mapping ID by aggregating rows from SCHE_TranformationTableColumns.","businessPurpose":"Helper SP used during the archive/promotion data transformation pipeline to retrieve the column mappings for a specific source-to-target table transformation. The column lists are used by the calling process to dynamically construct INSERT/SELECT SQL for copying user data between departments or rotation periods.","optimizationRecommendations":["The COALESCE-based string aggregation pattern is an older T-SQL idiom; STRING_AGG (available in SQL Server 2017+) is cleaner and performs better for this use case.","The parameter type @Params is declared as VeryShortText which may be too small to capture a useful MappingId value for error logging — verify the data type size.","No ordering is applied to the aggregation, meaning the column list order is non-deterministic; ORDER BY within the SELECT or an explicit OrderBy column should be added to ensure consistent column list output."],"migrationRelevance":"medium"},{"name":"GetMappingList","schema":"dbo","parameters":[],"lineCount":65,"tablesReferenced":["SCHE_TranformationTableColumns","SCHE_TranformationTableMapping"],"sprocsCalledFromBody":["spLOG_ErrorHandling"],"crudType":"get","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":false},"calledFromCode":[],"complexity":"moderate","aiEnrichment":null,"module":"SCHE","summary":"Retrieves the full list of table transformation mappings from SCHE_TranformationTableMapping with their associated column definitions, parent mapping relationships, and inclusion flags for archiving and promotion processes.","businessPurpose":"Provides the data transformation engine with its configuration: which source tables map to which target tables, what conditions apply during archiving or promotion, and how parent-child table relationships are navigated. This drives the dynamic data copying logic used when users are archived or promoted between departments.","optimizationRecommendations":["The ORDER BY MappingId DESC means parent mappings (lower IDs) appear after their children — if the calling process processes records in result-set order, this ordering may cause foreign key violations; verify the intended processing order.","The multiple LEFT OUTER JOINs back to SCHE_TranformationTableMapping and SCHE_TranformationTableColumns for parent relationships could result in a wide, sparse result set if parent mappings are rarely populated; consider returning parent info only when ParentMappingId is not null.","There is no filtering (no WHERE clause), so all mappings are always returned — if this table grows large, adding a parameter to filter by IncludedInArchivingProcess or IncludedInPromotionProcess would improve performance for callers that only need one type."],"migrationRelevance":"high"},{"name":"GetQueueListForArchiving","schema":"dbo","parameters":[],"lineCount":30,"tablesReferenced":["SCHE_UserArchiveSchedule"],"sprocsCalledFromBody":[],"crudType":"get","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"simple","aiEnrichment":null,"module":"SCHE","summary":"Returns the list of users currently in the archive queue whose archive effective date has passed and who are still pending (Status=0), joining archive queue, queue users, and the user archive schedule tables.","businessPurpose":"Polling SP used by the archive scheduler job to identify which users are due for archiving. It returns user and queue context needed to call CompleteArchivingProcess for each pending user, serving as the entry point for the automated archiving batch process.","optimizationRecommendations":["The commented-out WHERE condition 'QueueUsers.Status = @Status' suggests a parameter was removed; if Status is always 0, it should remain as a literal constant in the WHERE clause (which it does), but the dead comment should be removed.","An index on SCHE_UserArchiveSchedule(UserID, IsArchiveSchedule, ArchiveEffectiveDate) would directly support the join and filter conditions.","An index on Sche_ArchiveQueueUsers(ArchiveQueueID, Status, IsArchived) would support the WHERE clause filtering."],"migrationRelevance":"high"},{"name":"GetQueueListForTodayArchiving","schema":"dbo","parameters":[],"lineCount":34,"tablesReferenced":["SCHE_UserArchiveSchedule"],"sprocsCalledFromBody":[],"crudType":"get","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"simple","aiEnrichment":null,"module":"SCHE","summary":"Returns archive queue entries for users whose archive schedule was created or modified today and whose effective archive date is within 12 hours of that creation/modification time, limiting results to same-day urgent archiving tasks.","businessPurpose":"Variant of GetQueueListForArchiving that specifically targets same-day archiving requests, used when administrators schedule a user for immediate or same-day archiving. The 12-hour window ensures only recently-created schedules are processed, avoiding reprocessing of older records.","optimizationRecommendations":["The column name 'ArchiveSchedule.ModifiedDatae' appears to be a typo of 'ModifiedDate' — this should be corrected in both the SP and the underlying table definition.","CONVERT(DATE, ISNULL(ArchiveSchedule.ModifiedDatae, ArchiveSchedule.CreatedDate)) = @Today is non-sargable on the column; an index on both date columns and a direct range predicate would be more efficient.","The DATEDIFF(HOUR, ...) <= 12 condition combined with the = @Today date cast creates overlapping and potentially confusing filtering — document the intended business rule more clearly and consolidate into a single date range predicate.","Commented-out WHERE clauses for specific department IDs and a unit-test comment should be removed from the production SP."],"migrationRelevance":"high"},{"name":"InsertAutoEvalRemainderAssignmentEmailsInApplicationScheduler","schema":"dbo","parameters":[],"lineCount":60,"tablesReferenced":["SCHE_ApplicationEmailSchedules"],"sprocsCalledFromBody":[],"crudType":"insert","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":true,"hasTableVariable":false,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"moderate","aiEnrichment":null,"module":"SCHE","summary":"Bulk-inserts auto-evaluation reminder emails from a table-valued parameter into SCHE_ApplicationEmailSchedules, filtering out rows with empty or null ToEmailAddress or HtmlTemplate.","businessPurpose":"Queues batch email reminders for auto-evaluation assignment notifications in the application email scheduler. Used by the evaluation reminder pipeline to efficiently insert multiple email records in a single call rather than row-by-row inserts from the application layer.","optimizationRecommendations":["The filter conditions 'ToEmailAddress <> '''' AND ToEmailAddress IS NOT NULL' can be simplified to 'ToEmailAddress IS NOT NULL AND LEN(ToEmailAddress) > 0' or, better, validated upstream before passing to the SP to avoid wasted rows in the TVP.","No SET NOCOUNT ON is present, causing unnecessary rowcount messages for each inserted row — add SET NOCOUNT ON at the start.","No error handling (TRY/CATCH) is present — a failed INSERT would surface an unhandled exception to the caller with no logging."],"migrationRelevance":"medium"},{"name":"InsertManualAssignmentHistory","schema":"dbo","parameters":[{"name":"@UserID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@ManualAssignmentID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@StartDate","dataType":"LargeDate","direction":"IN","defaultValue":null},{"name":"@EndDate","dataType":"LargeDate","direction":"IN","defaultValue":null},{"name":"@UserEmail","dataType":"LargeText","direction":"IN","defaultValue":null}],"lineCount":17,"tablesReferenced":["SCHE_ManualAssignmentsHistory"],"sprocsCalledFromBody":[],"crudType":"insert","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"trivial","aiEnrichment":null,"module":"SCHE","summary":"Inserts a single audit log record into SCHE_ManualAssignmentsHistory capturing the manual assignment ID, date range, user details, and any error information.","businessPurpose":"Audit trail SP for manual rotation/evaluation assignment scheduling. Records each attempt to process a manual assignment, including error details if processing failed, enabling administrators to review the history of manual assignment operations in MyEvaluations.","optimizationRecommendations":["This SP is a thin wrapper over a single INSERT — it could be replaced by a direct parameterised INSERT from the application layer, reducing SP overhead for what is a trivial write operation.","No error handling is present; if the INSERT fails (e.g., constraint violation), the error propagates unhandled."],"migrationRelevance":"low"},{"name":"UpdateArchivingStatus","schema":"dbo","parameters":[{"name":"@ErrorInfo","dataType":"LargeText","direction":"IN","defaultValue":null},{"name":"@LastUpdatedDateTime","dataType":"LargeDate","direction":"IN","defaultValue":null},{"name":"@Status","dataType":"BigNumber","direction":"IN","defaultValue":null},{"name":"@UserId","dataType":"BigNumber","direction":"IN","defaultValue":null}],"lineCount":71,"tablesReferenced":["SCHE_ArchiveQueueUsers","SCHE_ArchivedUserMailQueue","SEC_Users"],"sprocsCalledFromBody":["CheckEmailStatus","spLOG_ErrorHandling"],"crudType":"update","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":false},"calledFromCode":[],"complexity":"moderate","aiEnrichment":null,"module":"SCHE","summary":"Updates a user's archive queue entry with the current status and error info, and if the user is archived and has a permanent email address, swaps the main email and permanent email fields (as of Jan 2025) and verifies the email status; also inserts a mail queue record for the archived user if one does not already exist.","businessPurpose":"Called during the archiving pipeline to record the outcome of the archiving attempt per user and to perform the email address swap that gives the archived user their personal (permanent) email as their primary contact going forward. The mail queue entry triggers the GenerateArchivedUserEmail SP to run and send the notification email.","optimizationRecommendations":["The email swap logic (swap MainEmail with PermanentEmail) was added in Jan 2025 via a modification — the DATALENGTH check for PermanentEmail is correct but inconsistent with the subsequent '' empty string check; use a single predicate like NULLIF(PermanentEmail, '') IS NOT NULL.","The nested EXEC CheckEmailStatus inside a conditional path means an external SP call occurs mid-transaction; if CheckEmailStatus is slow or fails, the entire archiving status update is at risk — consider separating the email verification from the status update.","The NOT EXISTS check before inserting into SCHE_ArchivedUserMailQueue could have a race condition under concurrent archiving jobs — an UPSERT (MERGE or INSERT ... WHERE NOT EXISTS with appropriate isolation) would be safer.","The UPDATE to SCHE_ArchiveQueueUsers does not verify that the row actually exists before updating — a @@ROWCOUNT check after the update would help detect queue inconsistencies."],"migrationRelevance":"high"},{"name":"UpdateManualAssignmentEmailStatus","schema":"dbo","parameters":[{"name":"@ManualAssignmentID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@LogInfo","dataType":"LargeText","direction":"IN","defaultValue":null}],"lineCount":25,"tablesReferenced":["SCHE_ManualAssignments"],"sprocsCalledFromBody":[],"crudType":"update","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"simple","aiEnrichment":null,"module":"SCHE","summary":"Marks a manual assignment's reminder email as sent by updating IsSentReminder=1, recording the log info and completion date for the given ManualAssignmentID.","businessPurpose":"Finalises the email reminder workflow for manual rotation/evaluation assignments by recording that the reminder email was successfully dispatched, preventing duplicate sends and providing an audit timestamp for when the reminder was completed.","optimizationRecommendations":["This is a single-row UPDATE with no error handling — add TRY/CATCH to log failures via spLOG_ErrorHandling for consistency with other SPs in this module.","No verification that the row exists before updating; a @@ROWCOUNT check would detect stale or incorrect ManualAssignmentIDs."],"migrationRelevance":"low"},{"name":"UpdatePromotionStatus","schema":"dbo","parameters":[{"name":"@ErrorInfo","dataType":"LargeText","direction":"IN","defaultValue":null},{"name":"@LastUpdatedDateTime","dataType":"LargeDate","direction":"IN","defaultValue":null},{"name":"@Status","dataType":"BigNumber","direction":"IN","defaultValue":null},{"name":"@UserId","dataType":"BigNumber","direction":"IN","defaultValue":null},{"name":"@QueueId","dataType":"BigNumber","direction":"IN","defaultValue":null}],"lineCount":78,"tablesReferenced":["SCHE_PromotedUserMailQueue","SCHE_PromotionQueueUsers","SEC_Users"],"sprocsCalledFromBody":["CheckEmailStatus","spLOG_ErrorHandling"],"crudType":"update","antiPatterns":{"hasCursor":false,"hasSelectStar":true,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":true,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":false},"calledFromCode":[],"complexity":"moderate","aiEnrichment":null,"module":"SCHE","summary":"Updates a user's promotion queue entry with the current status and error info, updates the promoted user mail queue to reflect promotion success or failure, and if the promoted user was archived, swaps their permanent email to be the main email address with email verification.","businessPurpose":"Counterpart to UpdateArchivingStatus for the promotion workflow. Records the outcome of a user promotion attempt, triggers the mail queue entry that will cause GeneratePromotedUserEmail to fire, and handles the email address swap for promoted-and-archived users, completing the user transition lifecycle in MyEvaluations.","optimizationRecommendations":["The UPDATE to SCHE_PromotedUserMailQueue uses 'WHERE oldUserID = @OldUserID AND IsEmailGenerated=0' — the variable @OldUserID is set by a prior SELECT from SCHE_PromotionQueueUsers using @UserId, but if that SELECT returns no rows, @OldUserID will be NULL and the UPDATE will silently match nothing; a NULL check is needed.","Same email swap logic as UpdateArchivingStatus — should be extracted into a shared helper SP to avoid duplication and maintenance drift.","The EXEC CheckEmailStatus call inside the TRY block can fail and trigger the CATCH, rolling back the status update even though the promotion itself succeeded; the email verification should be decoupled from the status update.","Hardcoded IsArchived=1 filter in the permanent email lookup means this branch never applies to non-archived promoted users — document whether this is intentional."],"migrationRelevance":"high"},{"name":"usp_CopyOldMailsToTempTable","schema":"dbo","parameters":[],"lineCount":158,"tablesReferenced":["SCHE_ApplicationEmailSchedules","SCHE_ApplicationEmailSchedulesTemp","TBL_ErrorLog"],"sprocsCalledFromBody":[],"crudType":"mixed","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":false},"calledFromCode":[],"complexity":"complex","aiEnrichment":null,"module":"SCHE","summary":"Migrates old emails from SCHE_ApplicationEmailSchedules to SCHE_ApplicationEmailSchedulesTemp in two batches: up to 200,000 successfully-sent records, and up to 200,000 unsent records created on or before 2022-05-10, then deletes the migrated rows from the source table.","businessPurpose":"One-time or periodic data migration SP that archived a large historical backlog of email records predating May 2022 from the live email queue table into the archival temp table. Likely executed as a one-off migration to reduce the size of SCHE_ApplicationEmailSchedules after the table grew excessively large, with the hard-coded date cutoff indicating this is a historical cleanup tool rather than an ongoing maintenance job.","optimizationRecommendations":["The cutoff date '2022-05-10' is hardcoded — this SP appears to be a one-off migration tool that should either be parameterised for reuse or removed if the migration is complete.","Two separate INSERT ... SELECT TOP 200000 blocks with overlapping column lists could be consolidated into a single INSERT with a UNION or OR condition, or parameterised by IsMailSent status.","The NOT EXISTS anti-join on SCHE_ApplicationEmailSchedulesTemp is evaluated per-row for up to 200,000 rows — an index on ApplicationEmailScheduleID in the temp table is critical for performance.","The #SCHE_ApplicationEmailSchedulesTemp temp table only holds IDs for the DELETE join, but the two INSERT batches each output into it via OUTPUT — if either batch exceeds 200,000 rows, the second batch will not migrate remaining rows; a loop-based approach would be more reliable.","The entire operation (up to 400,000 rows inserted + deleted) is wrapped in a single transaction — this will generate a very large transaction log and could cause blocking; batching into smaller transactions is strongly recommended."],"migrationRelevance":"low"}]}