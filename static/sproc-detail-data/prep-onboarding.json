{"module":"Prep","displayName":"Prep/Onboarding","procedureCount":17,"procedures":[{"name":"AssignSchedulePreferences","schema":"dbo","parameters":[{"name":"@LoginUserID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@DepartmentID","dataType":"LargeNumber","direction":"IN","defaultValue":null}],"lineCount":356,"tablesReferenced":["DH_DepartmentRotations","Prep_BuildSchedules","Prep_BuildSchedulesData","Prep_CampusLocationSessions","Prep_RotationRequirements","Prep_RotationRequirementsSettings","Prep_RotationRequirementsSettingsData","Prep_SiteAllocations","Prep_SiteAllocationsSettings","Prep_SiteAllocationsSettingsData","Prep_TraineeRanking","Prep_TraineeRankingData"],"sprocsCalledFromBody":[],"crudType":"mixed","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"complex","aiEnrichment":null,"module":"Prep","summary":"Assigns rotation preferences to trainees for a given build schedule by matching user preference rankings against rotation template settings, allocation constraints, and campus location sessions. It resolves conflicts between over-subscribed rotations by redistributing trainees to under-subscribed slots using a multi-pass allocation algorithm.","businessPurpose":"Core scheduling engine used in the Prep module when administrators trigger preference-based auto-assignment of residents to rotation blocks. It ensures each resident is placed into a rotation block that matches their ranked preference while respecting site allocation caps and cluster groupings.","optimizationRecommendations":["The SP creates 8+ temp tables and drops 16+ intermediate tables (#Table001 through #Table016) — consolidate into fewer temp tables or use CTEs to reduce tempdb pressure.","Multiple indexed temp tables (#tblUserPreferences has 8 non-clustered indexes) add significant overhead on small-to-medium datasets; benchmark whether fewer covering indexes suffice.","Repeated ISNULL() wrapping in join conditions (e.g., ISNULL(UP.ParentRotationID,0)=A.RotationID) prevents index seeks; store the computed value in the temp table column instead.","PRINT statements with GETDATE() scattered throughout are debugging artifacts left in production; remove them to reduce unnecessary overhead and log noise.","The CROSS JOIN between #tblUsers and #tblTemplateSettings (line 47) can be large; validate that the subsequent DELETE to de-duplicate is not masking a logic issue that should be addressed upstream."],"migrationRelevance":"high"},{"name":"GenerateEvaluationSchedulesForAuto","schema":"dbo","parameters":[{"name":"@DepartmentId","dataType":"LargeNumber","direction":"IN","defaultValue":null}],"lineCount":927,"tablesReferenced":["DH_DepartmentRotations","DH_MomentumSchedule","DH_QGendaSchedule","DH_SyncAMIONRotations","EVAL_AmionSchedule","EVAL_EvaluationSchedules","EVAL_SpInfoTypes","Prep_BuildSchedules","Prep_CallNames","Prep_ClinicNames","Prep_Shifts","Prep_TraineeReSchedulecalendar","Prep_TraineeReSchedulecalendarData","Prep_TraineeSchedulecalendar","Prep_TraineeSchedulecalendarData","SEC_Departments","SEC_UserRoles","SEC_Users"],"sprocsCalledFromBody":[],"crudType":"insert","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"very-complex","aiEnrichment":null,"module":"Prep","summary":"Automatically generates evaluation schedule entries in EVAL_EvaluationSchedules for a given department and academic year by detecting the most recent schedule publish date from multiple external scheduling systems (Amion, QGenda, Momentum, or Prep build schedules) and inserting evaluation schedule records for all active rotations, shifts, clinics, and calls not already covered.","businessPurpose":"Triggered in the Prep/Scheduling module after a new trainee schedule is published to automatically create the corresponding evaluation windows. It bridges the scheduling subsystem and the evaluation subsystem so that evaluations are ready to be triggered for each rotation, shift, clinic, and on-call assignment without manual administrator intervention.","optimizationRecommendations":["Four nearly identical INSERT INTO EVAL_EvaluationSchedules blocks (Rotations, Shifts, Clinics, Calls) are duplicated for both current-year and specific-rotation scenarios — extract to a parameterized helper SP or table-valued function to reduce ~500 lines of repetitive code.","Temporary table #tblEvaluationSchedules is used as an intermediate filter but then discarded; a single well-indexed CTE or derived table would avoid a round-trip to tempdb.","Multiple SELECT TOP 1 statements without ORDER BY determinism (aside on EvaluationScheduleID DESC) can be non-deterministic if IDs are not sequential; ensure business rules are enforced by explicit ordering.","The SP uses READ UNCOMMITTED isolation globally, which is correct for reporting reads but the INSERT statements that follow may benefit from a tighter isolation scope to avoid phantom reads during concurrent schedule publishing."],"migrationRelevance":"high"},{"name":"GetGoalsAndObjectivesData_Test","schema":"dbo","parameters":[{"name":"@DepartmentId","dataType":"BIGINT","direction":"IN","defaultValue":null},{"name":"@AcademicYearId","dataType":"INT","direction":"IN","defaultValue":null},{"name":"@DocumentSubjectId","dataType":"BIGINT","direction":"IN","defaultValue":null},{"name":"@EnableScheduleManagement","dataType":"BIT","direction":"IN","defaultValue":null},{"name":"@AcademicYearStart","dataType":"DATE","direction":"IN","defaultValue":null}],"lineCount":173,"tablesReferenced":["APE_CorePersonnelUsers","DH_DepartmentRotations","DH_SyncAMIONRotations","PF_UserDocumentNotifications","PF_UserDocuments","PF_UserReviews","Prep_BuildSchedules","Prep_BuildSchedulesData","Prep_TraineeReSchedulecalendar","Prep_TraineeReSchedulecalendarData","Prep_TraineeSchedulecalendar","Prep_TraineeSchedulecalendarData"],"sprocsCalledFromBody":[],"crudType":"get","antiPatterns":{"hasCursor":false,"hasSelectStar":true,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"very-complex","aiEnrichment":null,"module":"Prep","summary":"Retrieves rotation-level goals and objectives document data for a department and academic year, returning two result sets: (1) active rotations linked to competency evaluation milestone documents, with flags indicating AMION sync status and whether the rotation is used in the current schedule; and (2) aggregated document review and notification counts per document, rotation, and trainee PGY level.","businessPurpose":"Powers the Goals and Objectives reporting view in the Prep module, showing administrators which competency documents (CEMD section) have been reviewed or notified per rotation by trainee level. This is a test/development variant of the production SP, used to validate query logic before promotion.","optimizationRecommendations":["The second result set uses a UNION ALL across two large subqueries (PF_UserReviews and PF_UserDocumentNotifications) with multiple joins; materializing the intermediate results into a temp table before aggregation would reduce repeated scans.","dbo.[fnGetPGYForUserByDate] is called per row inside the CTE — this scalar UDF likely inhibits parallelism; replace with an inline TVF or precomputed PGY lookup joined to the result set.","Two temporary tables (#RotationsResult, #DocumentsResult) are created and immediately selected from — use a single CTE chain or direct SELECT to avoid the extra materialization if result sets are small."],"migrationRelevance":"medium"},{"name":"GetPreceptorDetails_Test","schema":"dbo","parameters":[{"name":"@LoginUserID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@DepartmentID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@UserID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@TemplateID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@IsDeleted","dataType":"SmallNumber","direction":"IN","defaultValue":null},{"name":"@AcademicYear","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@StartIndex","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@PageSize","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@SortBy","dataType":"LargeText","direction":"IN","defaultValue":null},{"name":"@Displayfilter","dataType":"LargeText","direction":"IN","defaultValue":"''"}],"lineCount":126,"tablesReferenced":["DH_DepartmentRotations","LA_Preceptors","Prep_CampusLocations","Prep_RegistrationDetails","Prep_SessionDetails","SEC_States"],"sprocsCalledFromBody":[],"crudType":"get","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":true,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"complex","aiEnrichment":null,"module":"Prep","summary":"Retrieves paginated preceptor details for a department, including preceptor name, email, location, rotation availability, and approval status, using dynamic SQL to support flexible column sorting and search filtering. Returns both the paginated result set and a total count.","businessPurpose":"Drives the preceptor listing grid in the Prep/Preceptor Management admin view, allowing administrators to browse, filter, and sort preceptors by approval status, location, and rotation availability. This is a test/development variant used during query refinement.","optimizationRecommendations":["Dynamic SQL is used solely for column-level sorting; this can be replaced with static SQL using conditional CASE expressions in the ORDER BY clause, eliminating sql injection risk surface and improving plan cacheability.","Correlated subqueries in the ORDER BY clause for RotationsAvailability sorting (SELECT top 1 from DH_DepartmentRotations per row) are O(n*m); pre-compute this in the outer SELECT using a JOIN.","The dynamic SQL is built by string concatenation and executed with EXEC(@Query) rather than sp_executesql with parameters — this prevents plan reuse and is a SQL injection risk if any parameter is user-controlled.","STRING_AGG with a SUBSTRING trim to 40 chars for RotationsAvailability and a separate full STRING_AGG for RotationsAvailability1 causes two GROUP BY aggregations over the same rows; compute both in one pass."],"migrationRelevance":"medium"},{"name":"GetScheduleShiftAssignments_20240906","schema":"dbo","parameters":[{"name":"@LoginUserID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@DepartmentID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@UserID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@ScheduleID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@AcademicYear","dataType":"LargeNumber","direction":"IN","defaultValue":null}],"lineCount":154,"tablesReferenced":["DH_DepartmentRotations","Prep_BuildSchedules","Prep_BuildSchedulesData","Prep_CallNames","Prep_CampusLocationSessions","Prep_ClinicNames","Prep_LinkTraineesToCampusCluster","Prep_Shifts","Prep_TraineeReSchedulecalendar","Prep_TraineeReSchedulecalendarData","Prep_TraineeScheduleClinicAssignments","Prep_TraineeScheduleShiftAssignments","Prep_TraineeSchedulecalendar","Prep_TraineeSchedulecalendarData"],"sprocsCalledFromBody":[],"crudType":"get","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"complex","aiEnrichment":null,"module":"Prep","summary":"Retrieves shift, clinic, and on-call assignments for trainees in a given schedule and academic year, resolving reschedule overrides over original assignments and returning multiple result sets (shifts, clinics, calls, combined assignments with date ranges).","businessPurpose":"Powers the schedule calendar view in the Prep module for shift-based schedules (IsShift != 0), showing each trainee's assigned shifts, clinic sessions, and on-call duties. Supports filtering by schedule, specific trainee, and cluster/campus.","optimizationRecommendations":["The SP copies three full tables into temp tables (#Prep_BuildSchedulesData, #Prep_BuildSchedules, #Prep_LinkTraineesToCampusCluster) with no row-level filtering other than DepartmentID — add AcademicYear and UserID filters at the copy step to reduce tempdb usage.","PRINT statements (001 through 012) with GETDATE() are debugging artifacts; remove from production code.","The second INSERT into #tblShiftAssignments uses a complex inline subquery with a ROW_NUMBER() partition over 7 columns; materialize this into a temp table with an index before joining to Prep_Shifts, Prep_ClinicNames, and Prep_CallNames.","Multiple result sets (4 SELECT statements at the end) could be consolidated into a single parameterized call or split into separate purpose-specific SPs to allow individual caching and optimization."],"migrationRelevance":"high"},{"name":"GetTraineeRegistrationFormbyAdmin","schema":"dbo","parameters":[{"name":"@PreceptorID","dataType":"LargeNumber","direction":"IN","defaultValue":null}],"lineCount":19,"tablesReferenced":["Prep_SessionDetails"],"sprocsCalledFromBody":[],"crudType":"get","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"trivial","aiEnrichment":null,"module":"Prep","summary":"Retrieves the registration form data submitted by a trainee for a specific preceptor request, including contact details, rotation/site preferences, and session details for the associated academic year.","businessPurpose":"Used in the Prep/Preceptor Management workflow when administrators review a preceptor request form submitted by a trainee, providing all the relevant fields needed to approve or reject the preceptor-trainee pairing.","optimizationRecommendations":[],"migrationRelevance":"low"},{"name":"GetTraineeSchedules_20250926","schema":"dbo","parameters":[{"name":"@LoginUserID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@DepartmentID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@UserID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@ScheduleID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@AcademicYear","dataType":"LargeNumber","direction":"IN","defaultValue":null}],"lineCount":1422,"tablesReferenced":["ACT_Sessions","BSN_CourseCampusClinicalCoordinator","DH_DepartmentRotations","DH_RotationsLinkedDepartments","LA_Preceptors","PF_AffiliateAgreement","Prep_BuildSchedules","Prep_BuildSchedulesData","Prep_CallNames","Prep_CampusLocationSessions","Prep_CampusLocations","Prep_ClinicNames","Prep_ClusterNames","Prep_LinkTraineesToCampusCluster","Prep_RotationRequirements","Prep_RotationRequirementsSettings","Prep_RotationRequirementsSettingsData","Prep_Shifts","Prep_SiteAllocations","Prep_SiteAllocationsSettings","Prep_SiteAllocationsSettingsData","Prep_SiteNames","Prep_TraineeReSchedulecalendar","Prep_TraineeReSchedulecalendarData","Prep_TraineeReSchedulecalendarHistory","Prep_TraineeSchedulecalendar","Prep_TraineeSchedulecalendarData","SEC_Departments","SEC_Programs","SEC_UserRoles","SEC_Users","SEC_UsersExt"],"sprocsCalledFromBody":["AssignSchedulePreferences","GetAdminCampusLocations"],"crudType":"get","antiPatterns":{"hasCursor":false,"hasSelectStar":true,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"very-complex","aiEnrichment":null,"module":"Prep","summary":"A dated intermediate version of the main GetTraineeSchedules procedure from September 2026, retrieving full trainee rotation schedule data for a department including rotation assignments, rescheduled overrides, campus cluster context, preceptor assignments, rotation requirements, and block calendar data. Supports role-based access filtering and multiple return result sets.","businessPurpose":"This is a point-in-time snapshot of the master schedule display SP used during active development in the Prep module. It powers the main trainee schedule calendar view showing residents their rotation assignments per block/session, with support for admin, campus leader, preceptor, and trainee role views.","optimizationRecommendations":["Four large schedule tables are copied into temp tables at the top (SELECT * INTO #Prep_TraineeSchedulecalendar, etc.) filtering only on DepartmentID — add AcademicYear and ScheduleID filters at the copy step to dramatically reduce the working set.","The SP is over 119KB (roughly 2,500+ lines) and performs dozens of joins, temp table operations, and multi-result-set returns — it should be decomposed into focused sub-procedures (one for schedule resolution, one for block data, one for preceptor data) to improve maintainability.","PRINT debugging statements (001 through many) remain throughout production code; remove them.","Multiple EXEC calls to other SPs (GetAdminCampusLocations) inside a loop or conditional block can cause nested execution plans; consider inlining the query or using a temp table populated once.","READ UNCOMMITTED is applied globally but write operations are also performed via EXEC UpdateScheduleIncorrectBlocks3 within the same call scope — ensure isolation levels are appropriate for the write path."],"migrationRelevance":"high"},{"name":"GetTraineeSchedules_20251008","schema":"dbo","parameters":[{"name":"@LoginUserID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@DepartmentID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@UserID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@ScheduleID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@AcademicYear","dataType":"LargeNumber","direction":"IN","defaultValue":null}],"lineCount":1566,"tablesReferenced":["ACT_Sessions","BSN_CourseCampusClinicalCoordinator","DH_DepartmentRotations","DH_RotationsLinkedDepartments","LA_Preceptors","PF_AffiliateAgreement","Prep_BuildSchedules","Prep_BuildSchedulesData","Prep_CallNames","Prep_CampusLocationSessions","Prep_CampusLocations","Prep_ClinicNames","Prep_ClusterNames","Prep_LinkTraineesToCampusCluster","Prep_RotationRequirements","Prep_RotationRequirementsSettings","Prep_RotationRequirementsSettingsData","Prep_Shifts","Prep_SiteAllocations","Prep_SiteAllocationsSettings","Prep_SiteAllocationsSettingsData","Prep_SiteNames","Prep_TraineeReSchedulecalendar","Prep_TraineeReSchedulecalendarData","Prep_TraineeReSchedulecalendarHistory","Prep_TraineeSchedulecalendar","Prep_TraineeSchedulecalendarData","SEC_Departments","SEC_Programs","SEC_UserRoles","SEC_Users","SEC_UsersExt"],"sprocsCalledFromBody":["AssignSchedulePreferences","GetAdminCampusLocations"],"crudType":"get","antiPatterns":{"hasCursor":false,"hasSelectStar":true,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"very-complex","aiEnrichment":null,"module":"Prep","summary":"A later dated version of GetTraineeSchedules from October 2026, functionally equivalent to the _20250926 variant but with explicit CREATE TABLE definitions for all temp tables (rather than SELECT * INTO) to give greater control over the schema and indexes of the intermediate tables.","businessPurpose":"A development iteration of the main trainee schedule display procedure, introducing explicit temp table schema definitions as a refactoring step. Used to test the impact of typed temp table creation on query plan stability versus the previous SELECT * INTO approach.","optimizationRecommendations":["Same structural concerns as GetTraineeSchedules_20250926 apply — the SP is 127KB and should be decomposed.","Explicit CREATE TABLE definitions for all temp tables (vs SELECT * INTO in the prior version) is an improvement for plan stability and should be retained when the SP is consolidated.","The production SP (GetTraineeSchedules without a date suffix) should be the only active version — these dated variants should be retired and dropped to reduce maintenance burden.","All three GetTraineeSchedules variants (_20250926, _20251008, _Test) coexist in the database; audit which one is actually called by application code and deprecate the others."],"migrationRelevance":"high"},{"name":"GetTraineeSchedules_Test","schema":"dbo","parameters":[{"name":"@LoginUserID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@DepartmentID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@UserID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@ScheduleID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@AcademicYear","dataType":"LargeNumber","direction":"IN","defaultValue":null}],"lineCount":1303,"tablesReferenced":["ACT_Sessions","BSN_CourseCampusClinicalCoordinator","DH_DepartmentRotations","DH_RotationsLinkedDepartments","LA_Preceptors","PF_AffiliateAgreement","Prep_BuildSchedules","Prep_BuildSchedulesData","Prep_CallNames","Prep_CampusLocationSessions","Prep_CampusLocations","Prep_ClinicNames","Prep_ClusterNames","Prep_LinkTraineesToCampusCluster","Prep_RotationRequirements","Prep_RotationRequirementsSettings","Prep_RotationRequirementsSettingsData","Prep_Shifts","Prep_SiteAllocations","Prep_SiteAllocationsSettings","Prep_SiteAllocationsSettingsData","Prep_SiteNames","Prep_TraineeReSchedulecalendar","Prep_TraineeReSchedulecalendarData","Prep_TraineeReSchedulecalendarHistory","Prep_TraineeSchedulecalendar","Prep_TraineeSchedulecalendarData","SEC_Departments","SEC_Programs","SEC_UserRoles","SEC_Users","SEC_UsersExt"],"sprocsCalledFromBody":["AssignSchedulePreferences","GetAdminCampusLocations"],"crudType":"get","antiPatterns":{"hasCursor":false,"hasSelectStar":true,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"very-complex","aiEnrichment":null,"module":"Prep","summary":"A test development variant of the GetTraineeSchedules procedure, functionally equivalent to the production version but without the explicit typed temp table definitions introduced in _20251008, retaining the SELECT * INTO pattern from the _20250926 version.","businessPurpose":"Used by developers during testing and debugging of the schedule display logic in the Prep module without risk of modifying the production SP. It allows isolated query changes to be validated against live data.","optimizationRecommendations":["This variant should be dropped from production databases after development is complete — test SPs should not live alongside production SPs.","All optimizations identified for GetTraineeSchedules_20250926 apply equally here."],"migrationRelevance":"low"},{"name":"PreceptorAvaibilityReportResult_20221018","schema":"dbo","parameters":[{"name":"@LoginUserID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@DepartmentID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@EndDate","dataType":"LargeDate","direction":"IN","defaultValue":null},{"name":"@Campus","dataType":"LargeText","direction":"IN","defaultValue":null},{"name":"@Rotations","dataType":"LargeText","direction":"IN","defaultValue":null},{"name":"@Sites","dataType":"LargeText","direction":"IN","defaultValue":null},{"name":"@DemographicFields","dataType":"LargeText","direction":"IN","defaultValue":null}],"lineCount":345,"tablesReferenced":["ACT_Sessions","BSN_CourseCampusClinicalCoordinator","DH_DepartmentRotations","LA_Preceptors","Prep_CampusLocations","Prep_RequestFormByTrainee","Prep_SessionDetails","Prep_SiteNames","Prep_TraineeReSchedulecalendar","Prep_TraineeReSchedulecalendarData","Prep_TraineeSchedulecalendar","Prep_TraineeSchedulecalendarData","SEC_InstitutionUsers","SEC_LayoutFields","SEC_UserRoles","SEC_Users"],"sprocsCalledFromBody":["GetAdminCampusLocations","usp_PreceptorDemographicsFields"],"crudType":"mixed","antiPatterns":{"hasCursor":false,"hasSelectStar":true,"hasDynamicSql":true,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"very-complex","aiEnrichment":null,"module":"Prep","summary":"Generates a multi-result-set preceptor availability report for administrators, returning (1) a sorted list of distinct preceptors with their assigned rotations and campuses, (2) rotation/campus aggregated position counts with allocated vs. remaining positions, (3) site-level breakdowns, and (4) session-level breakdowns including demographic fields populated via a dynamic column pivot loop.","businessPurpose":"Powers the Preceptor Availability Report in the Prep module, allowing administrators to see how many trainee slots each preceptor can accommodate at each rotation, campus, site, and session — and how many are already filled. The demographic fields section allows customized demographic columns to appear in the report output.","optimizationRecommendations":["A WHILE loop iterates over demographic field IDs and issues ALTER TABLE on a temp table per iteration, then EXECs usp_PreceptorDemographicsFields per preceptor — both loops should be replaced with a single pivot or dynamic column query executed once.","Another WHILE loop iterates over each preceptor and calls usp_PreceptorDemographicsFields — this N+1 pattern causes one EXEC per preceptor row and should be batched into a single set-based call.","Dynamic SQL built via @pSQLQuery concatenation for the ORDER BY is used even for a simple sort — replace with a static ORDER BY.","Three result sets for the same preceptor data at different grouping levels (rotation, rotation+site, rotation+site+session) involve three separate GROUP BY queries over the same temp table; a ROLLUP or GROUPING SETS query would be more efficient."],"migrationRelevance":"medium"},{"name":"SavePreceptorTraineeSchedules_01292026","schema":"dbo","parameters":[{"name":"@LoginDepartmentID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@LoginUserID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@UserID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@AcademicYear","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@ScheduleID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@ScheduleName","dataType":"LargeText","direction":"IN","defaultValue":null},{"name":"@isPublish","dataType":"VerySmallNumber","direction":"IN","defaultValue":"0"},{"name":"@UserIds","dataType":"LargeText","direction":"IN","defaultValue":"''"}],"lineCount":2188,"tablesReferenced":["ACT_Sessions","Prep_BuildSchedules","Prep_BuildSchedulesData","Prep_CampusLocationSessions","Prep_CampusLocations","Prep_ClusterNames","Prep_LinkTraineesToCampusCluster","Prep_TraineeReSchedulecalendar","Prep_TraineeReSchedulecalendarData","Prep_TraineeReSchedulecalendarHistory","Prep_TraineeReSchedulecalendarLogs","Prep_TraineeSchedulecalendar","Prep_TraineeSchedulecalendarData","SEC_Departments","SEC_UserRoles","SEC_UserTypes","SEC_Users"],"sprocsCalledFromBody":["UpdateShiftAssignmentsForMyGME","usp_SaveUserDayOffsFromJson"],"crudType":"mixed","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":false},"calledFromCode":[],"complexity":"very-complex","aiEnrichment":null,"module":"Prep","summary":"Saves and updates trainee schedule assignments for a given build schedule, handling new user registration into cluster groups, building schedule data linkage, updating existing schedule calendar entries from a passed table-valued parameter, sending email notifications for schedule changes, and writing final schedule data to Prep_TraineeSchedulecalendar and Prep_TraineeReSchedulecalendarData tables.","businessPurpose":"The primary write SP for the Prep scheduling workflow — called when an administrator publishes or updates a trainee schedule, ensuring all trainee-rotation-session-preceptor relationships are persisted, cluster assignments are created or updated, and email notifications are dispatched to affected trainees.","optimizationRecommendations":["The SP is 107KB and performs user management, schedule persistence, and email notification in a single transaction — decompose into at least three focused SPs (user cluster management, schedule data save, email dispatch) to improve testability and rollback granularity.","A WHILE loop is used to iterate over trainees for email template generation — this should be replaced with a set-based approach using STRING_AGG or FOR XML PATH for email body construction.","Multiple UPDATE statements on #tblSelectedUsers for ClusterNameID resolution could be consolidated into a single UPDATE with a COALESCE join.","The SP uses BEGIN TRANSACTION / COMMIT but the email sending logic should be outside the transaction scope to prevent long-held locks while email templates are being constructed.","The table-valued parameter @tblPrepTraineeSchedules is copied into a temp table with SELECT * INTO and then a clustered index is created — the clustered index definition should match the join pattern to avoid sort operations."],"migrationRelevance":"high"},{"name":"Sp_UserAutoComplete","schema":"dbo","parameters":[{"name":"@prefix","dataType":"LargeText","direction":"IN","defaultValue":null},{"name":"@DepartmentId","dataType":"LargeNumber","direction":"IN","defaultValue":null}],"lineCount":12,"tablesReferenced":["Prep_TraineeSchedulecalendar"],"sprocsCalledFromBody":[],"crudType":"get","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":true,"nolockCount":1,"missingSetNocountOn":true,"hasTableVariable":false,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"trivial","aiEnrichment":null,"module":"Prep","summary":"Returns the top 10 trainees (by name) in a given schedule whose names match a provided prefix string, along with their PGY level computed via the GetPGYLevelForUser function.","businessPurpose":"Drives the trainee name autocomplete/typeahead input on the schedule management screens in the Prep module, allowing administrators to quickly search for and select trainees by partial name.","optimizationRecommendations":["The LIKE '%'+@prefix+'%' pattern prevents index usage on the name column — if name searches are frequent, consider adding a full-text index or using a left-anchored LIKE (@prefix+'%') pattern instead.","GetPGYLevelForUser is a scalar UDF called per row for up to 10 rows — low impact at TOP 10 but the UDF should be validated as inline-eligible."],"migrationRelevance":"low"},{"name":"UpdateScheduleIncorrectBlocks","schema":"dbo","parameters":[{"name":"@DepartmentID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@UserID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@ScheduleID","dataType":"LargeNumber","direction":"IN","defaultValue":"0"}],"lineCount":441,"tablesReferenced":["Prep_BuildSchedules","Prep_CampusLocationSessions","Prep_TraineeReSchedulecalendar","Prep_TraineeReSchedulecalendarData","Prep_TraineeReSchedulecalendarHistory","Prep_TraineeSchedulecalendar","Prep_TraineeSchedulecalendarData"],"sprocsCalledFromBody":[],"crudType":"update","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"complex","aiEnrichment":null,"module":"Prep","summary":"Repairs misaligned session date ranges and block section assignments in Prep_TraineeSchedulecalendar and related tables for a given department and academic year, by cross-referencing current campus location session date ranges against stored schedule data and updating or inserting missing records where session dates have drifted out of their block boundaries.","businessPurpose":"A data correction utility in the Prep module run after schedule template changes or session date adjustments to ensure that all trainee calendar entries (original and rescheduled) have correct session start/end dates, block section numbers, and campus location session IDs consistent with the current session calendar.","optimizationRecommendations":["Multiple UPDATE statements on Prep_TraineeSchedulecalendar, Prep_TraineeSchedulecalendarData, Prep_TraineeReSchedulecalendar, and Prep_TraineeReSchedulecalendarData — all using multi-table joins — should be preceded by targeted index checks on TraineeSchedulecalendarID and CampusLocationSessionID.","The bug on line 144 (SET S.PreceptorID = T.SiteNameID) appears to be a copy-paste error — PreceptorID is being set to the SiteNameID value, which is incorrect and should be investigated.","Repeated nested joins across the same large schedule tables in multiple consecutive UPDATE statements could benefit from materializing the cross-reference into a temp table once and joining against it.","READ UNCOMMITTED isolation is set at the top but the SP performs DML (INSERT, UPDATE) — verify that dirty reads from the schedule tables do not introduce data integrity issues during concurrent schedule saves."],"migrationRelevance":"high"},{"name":"UpdateScheduleIncorrectBlocks2","schema":"dbo","parameters":[{"name":"@DepartmentID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@UserID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@ScheduleID","dataType":"LargeNumber","direction":"IN","defaultValue":"0"}],"lineCount":459,"tablesReferenced":["Prep_BuildSchedules","Prep_CampusLocationSessions","Prep_TraineeReSchedulecalendar","Prep_TraineeReSchedulecalendarData","Prep_TraineeSchedulecalendar","Prep_TraineeSchedulecalendarData"],"sprocsCalledFromBody":[],"crudType":"update","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"complex","aiEnrichment":null,"module":"Prep","summary":"A second generation of the block correction utility that repairs block section number assignments and session date boundaries in trainee schedule data using a recursive CTE to detect and group overlapping block date ranges, then upserts the corrected data back to the original schedule tables.","businessPurpose":"Addresses more complex multi-block overlap scenarios than the original UpdateScheduleIncorrectBlocks, handling cases where a trainee's rotation assignments span across session boundaries or where date ranges incorrectly overlap consecutive blocks.","optimizationRecommendations":["The recursive CTE (CTE) processes every row in #tblTraineeSchedulecalendarData — with large datasets this can exhaust the default 100-recursion limit or cause excessive memory usage; add OPTION (MAXRECURSION 0) defensively and document the expected depth.","Two separate INSERT paths (one for rescheduled data, one for original schedule data) build block section numbers using ROW_NUMBER() in separate queries that are structurally identical except for the source table — consolidate with a UNION ALL before the ROW_NUMBER() application.","The UPDATE on #tblTraineeSchedulecalendarData that clamps StartDate/EndDate to SessionStartDate/SessionEndDate is correct but is repeated (similar logic exists in UpdateScheduleIncorrectBlocks3) — extract to a shared SP.","No indexes are created on #tblTraineeSchedulecalendarData or #tblTraineeUpdatedData temp tables before the heavy join/update operations."],"migrationRelevance":"high"},{"name":"UpdateScheduleIncorrectBlocks3","schema":"dbo","parameters":[{"name":"@DepartmentID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@UserID","dataType":"LargeNumber","direction":"IN","defaultValue":null},{"name":"@ScheduleID","dataType":"LargeText","direction":"IN","defaultValue":"''"},{"name":"@AcademicYear","dataType":"LargeNumber","direction":"IN","defaultValue":"0"}],"lineCount":695,"tablesReferenced":["Prep_BuildSchedules","Prep_BuildSchedulesData","Prep_CampusLocationSessions","Prep_CampusLocationSessionsHistory","Prep_TraineeReSchedulecalendar","Prep_TraineeReSchedulecalendarData","Prep_TraineeReSchedulecalendarHistory","Prep_TraineeSchedulecalendar","Prep_TraineeSchedulecalendarData"],"sprocsCalledFromBody":[],"crudType":"update","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"very-complex","aiEnrichment":null,"module":"Prep","summary":"The most comprehensive block correction utility in the series, extending UpdateScheduleIncorrectBlocks2 to handle both rescheduled and non-rescheduled data simultaneously, support per-user and per-schedule filtering via comma-delimited parameters parsed with STRING_SPLIT, track session history for detecting stale previous session dates, and create missing Prep_TraineeSchedulecalendar and Prep_TraineeReSchedulecalendar rows where they are absent.","businessPurpose":"The production-grade block correction SP called by usp_RefreshTraineeSchedulesData_Job for asynchronous background refresh jobs. It processes up to N schedules and optionally filters to specific users, making it suitable for bulk correction during academic year transitions or post-deployment schema migrations.","optimizationRecommendations":["Comma-delimited ScheduleID and UserID lists are parsed with STRING_SPLIT and loaded into #tblScheduleIDs / #tblUsers — no indexes are created on these tables before they are used in EXISTS/JOIN conditions throughout the SP; add clustered or covering indexes immediately after INSERT.","The recursive CTE (CTE1) with overlap detection processes all rows in #tblTraineeSchedulecalendarData — this is the largest and most memory-intensive operation; partition input data by ScheduleID before the recursive CTE to reduce memory pressure.","The SP performs INSERT INTO Prep_TraineeSchedulecalendar and Prep_TraineeReSchedulecalendar for missing rows using LEFT OUTER JOIN IS NULL patterns — ensure these target tables have appropriate unique constraints to prevent duplicate insertions under concurrent calls.","Joining Prep_CampusLocationSessionsHistory in the CampusLocationSessions setup query adds a potentially large history table to the resolution chain; verify this join is necessary and indexed correctly on CampusLocationSessionID.","The UPDATE step that clamps StartDate/EndDate based on PrevSessionStartDate/PrevSessionEndDate contains conditional logic that may produce incorrect EndDate when EndDate < StartDate (sets to SessionEndDate) — add a unit test scenario for this edge case."],"migrationRelevance":"high"},{"name":"usp_RefreshTraineeSchedulesData_Job","schema":"dbo","parameters":[],"lineCount":112,"tablesReferenced":["Prep_RefreshTraineeScheduleCalendarData"],"sprocsCalledFromBody":["GetTraineeSchedules","UpdateScheduleIncorrectBlocks3"],"crudType":"mixed","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":false,"hasTempTable":true,"hasWhileLoop":false,"hasNoTryCatch":false},"calledFromCode":[],"complexity":"moderate","aiEnrichment":null,"module":"Prep","summary":"A job-oriented wrapper SP that processes up to 10 pending refresh requests from the Prep_RefreshTraineeScheduleCalendarData queue table, calling UpdateScheduleIncorrectBlocks3 and GetTraineeSchedules for each requested schedule, then marking requests as complete or recording error messages on failure.","businessPurpose":"Implements asynchronous background refresh of trainee schedule calendar data in the Prep module. When schedule changes trigger a refresh request, this SP is called by a scheduled SQL Agent job to process the queue without blocking the web request that initiated the change.","optimizationRecommendations":["Processing is limited to TOP 10 rows from the queue per invocation — if high volumes of refresh requests queue up, consider increasing this batch size or running the job more frequently rather than hardcoding 10.","Each iteration calls two expensive SPs (UpdateScheduleIncorrectBlocks3 and GetTraineeSchedules) sequentially within the same transaction — the GetTraineeSchedules call (a read-only reporting SP) should be outside the transaction to reduce lock duration.","Error handling rolls back the entire transaction but only logs the error to the temp table — implement a persistent error log table rather than relying on the temp table which is discarded after the job run.","The WHILE loop pattern for batch processing is standard but the inner BEGIN TRANSACTION / COMMIT per row means N round-trips to the log — batch commit across all rows in the iteration, or use a TRY/CATCH at the loop level."],"migrationRelevance":"medium"},{"name":"usp_SaveUserDayOffsFromJson","schema":"dbo","parameters":[{"name":"@json","dataType":"NVARCHAR(MAX)","direction":"IN","defaultValue":null}],"lineCount":107,"tablesReferenced":["Prep_TraineeSchedulecalendarDaysOff"],"sprocsCalledFromBody":[],"crudType":"mixed","antiPatterns":{"hasCursor":false,"hasSelectStar":false,"hasDynamicSql":false,"hasNolock":false,"nolockCount":0,"missingSetNocountOn":false,"hasTableVariable":true,"hasTempTable":false,"hasWhileLoop":false,"hasNoTryCatch":true},"calledFromCode":[],"complexity":"moderate","aiEnrichment":null,"module":"Prep","summary":"Parses a JSON array of day-off records using OPENJSON and performs an upsert (MERGE) into Prep_TraineeSchedulecalendarDaysOff, matching on UserId, BlockDate, SessionID, and ScheduleID to either update existing day-off flags or insert new records.","businessPurpose":"Used in the Prep module when trainees or administrators save day-off designations on the schedule calendar, allowing bulk save of multiple block date entries in a single SP call via a JSON payload rather than individual row-by-row inserts.","optimizationRecommendations":["The MERGE statement matches on four columns (UserId, BlockDate, SessionID, ScheduleID) — verify that Prep_TraineeSchedulecalendarDaysOff has a composite index or unique constraint on these columns to ensure the MERGE uses an index seek rather than a table scan.","The @DayOffs TABLE variable is used as the MERGE source — for large JSON payloads, a temp table with indexes on the match keys would perform better than a table variable."],"migrationRelevance":"medium"}]}